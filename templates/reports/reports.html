<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Reports Manager</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:system-ui;margin:20px;max-width:1100px}
    .flex{display:flex;gap:20px;align-items:flex-start}
    .panel{flex:1;padding:12px;border:1px solid #ddd;border-radius:6px;background:#fafafa}
    textarea{width:100%;min-height:120px;font-family:monospace}
    input,textarea,button{margin:6px 0;padding:8px}
    ul{padding-left:18px}
    .small{font-size:13px;color:#666}
  </style>
</head>
<body>
  <h1>Reports Manager</h1>
  <div class="flex">
    <div class="panel" style="flex:0 0 380px;">
      <h2>Create / Edit Report</h2>
      <div>
        <label class="small">Title</label><br>
        <input id="title" placeholder="Title">
      </div>
      <div>
        <label class="small">Description</label><br>
        <input id="description" placeholder="Short description">
      </div>
      <div>
        <label class="small">Generated by</label><br>
        <input id="generated_by" placeholder="Script / user">
      </div>
      <div>
        <label class="small">Data (JSON) — e.g. {"labels":["A","B"],"values":[1,2]}</label><br>
        <textarea id="data_json" placeholder='{"labels":["A","B"],"values":[1,2]}'></textarea>
      </div>

      <div>
        <button id="createBtn">Create</button>
        <button id="updateBtn" disabled>Update</button>
        <button id="deleteBtn" disabled>Delete</button>
        <button id="clearBtn">Clear</button>
      </div>

      <hr>
      <h3>Saved Reports</h3>
      <input id="filter" placeholder="Filter by title..." style="width:100%">
      <ul id="reportsList"></ul>
    </div>

    <div class="panel">
      <h2>Visualization</h2>
      <canvas id="chart" width="700" height="360"></canvas>
      <div id="meta" class="small" style="margin-top:12px"></div>
    </div>
  </div>

  <script>
    const API_BASE = '/api/reports/';
    let selectedId = null;
    let chart = null;

    // Helpers
    function showError(msg){ alert(msg); }
    function parseJSONSafe(s){
      try { return JSON.parse(s); } catch(e) { return null; }
    }
    function setForm(report){
      selectedId = report?.id || null;
      document.getElementById('title').value = report?.title || '';
      document.getElementById('description').value = report?.description || '';
      document.getElementById('generated_by').value = report?.generated_by || '';
      document.getElementById('data_json').value = report?.data ? JSON.stringify(report.data, null, 2) : '';
      document.getElementById('updateBtn').disabled = !selectedId;
      document.getElementById('deleteBtn').disabled = !selectedId;
      if(report) renderChart(report);
    }
    function clearForm(){
      selectedId = null;
      document.getElementById('title').value = '';
      document.getElementById('description').value = '';
      document.getElementById('generated_by').value = '';
      document.getElementById('data_json').value = '';
      document.getElementById('updateBtn').disabled = true;
      document.getElementById('deleteBtn').disabled = true;
      if(chart){ chart.destroy(); chart = null; }
      document.getElementById('meta').innerText = '';
    }

    // CRUD operations
    async function loadReports(){
      const res = await fetch(API_BASE);
      if(!res.ok){ showError('Failed to load reports'); return; }
      const list = await res.json();
      renderList(list);
    }

    function renderList(list){
      const ul = document.getElementById('reportsList');
      const filter = document.getElementById('filter').value.toLowerCase();
      ul.innerHTML = '';
      (list || []).forEach(rep=>{
        if(filter && !(rep.title||'').toLowerCase().includes(filter)) return;
        const li = document.createElement('li');
        li.style.marginBottom = '8px';
        const title = document.createElement('a');
        title.href = '#';
        title.innerText = rep.title || `Report ${rep.id}`;
        title.onclick = (e)=>{
          e.preventDefault();
          setForm(rep);
        };
        li.appendChild(title);
        const meta = document.createElement('div');
        meta.className = 'small';
        meta.innerText = `id:${rep.id} • by:${rep.generated_by || '—'} • ${new Date(rep.created_at).toLocaleString()}`;
        li.appendChild(meta);
        ul.appendChild(li);
      });
    }

    async function createReport(){
      const payload = collectForm();
      if(!payload) return;
      const res = await fetch(API_BASE, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!res.ok){ showError('Create failed'); return; }
      await loadReports();
      clearForm();
    }

    async function updateReport(){
      if(!selectedId){ showError('Select a report to update'); return; }
      const payload = collectForm();
      if(!payload) return;
      const res = await fetch(API_BASE + selectedId + '/', {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!res.ok){ showError('Update failed'); return; }
      const updated = await res.json();
      setForm(updated);
      await loadReports();
    }

    async function deleteReport(){
      if(!selectedId){ showError('Select a report to delete'); return; }
      if(!confirm('Delete selected report?')) return;
      const res = await fetch(API_BASE + selectedId + '/', { method: 'DELETE' });
      if(res.status !== 204){ showError('Delete failed'); return; }
      await loadReports();
      clearForm();
    }

    function collectForm(){
      const title = document.getElementById('title').value.trim();
      if(!title){ showError('Title is required'); return null; }
      const description = document.getElementById('description').value.trim();
      const generated_by = document.getElementById('generated_by').value.trim();
      const data_text = document.getElementById('data_json').value.trim();
      const data = data_text ? parseJSONSafe(data_text) : null;
      if(data_text && data === null){ showError('data JSON is invalid'); return null; }
      return { title, description, generated_by, data };
    }

    function renderChart(rep){
      const canvas = document.getElementById('chart');
      const ctx = canvas.getContext('2d');
      const labels = (rep.data && rep.data.labels) || [];
      const values = (rep.data && rep.data.values) || [];
      document.getElementById('meta').innerText = `Report: ${rep.title} — ${rep.description || ''}`;
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: rep.title, data: values, backgroundColor: 'rgba(54,162,235,0.6)' }] },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    // Event wiring
    document.getElementById('createBtn').onclick = createReport;
    document.getElementById('updateBtn').onclick = updateReport;
    document.getElementById('deleteBtn').onclick = deleteReport;
    document.getElementById('clearBtn').onclick = clearForm;
    document.getElementById('filter').oninput = loadReports;

    // initial load
    loadReports();
  </script>
</body>
</html>